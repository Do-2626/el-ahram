<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام إدارة المنتجات والفواتير</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --success-color: #27ae60;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --light-bg: #f8f9fa;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background-color: var(--light-bg);
        color: #333;
        font-size: 16px;
      }

      .navbar {
        background-color: var(--primary-color) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        padding: 1rem 0;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.3rem;
      }

      .card {
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      }

      .table-container {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .table {
        margin-bottom: 0;
      }

      .table th {
        background-color: var(--primary-color);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        padding: 1rem;
        border: none;
      }

      .table th:hover {
        background-color: #34495e;
      }

      .table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
      }

      .search-box {
        position: relative;
        margin-bottom: 1.5rem;
      }

      .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1.2rem;
      }

      .search-box input {
        padding-right: 45px;
        border-radius: 50px;
        border: 2px solid #e0e0e0;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .search-box input:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      }

      .btn-add-cart {
        background-color: var(--success-color);
        border: none;
        border-radius: 50px;
        padding: 0.5rem 1.2rem;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
      }

      .btn-add-cart:hover {
        background-color: #229954;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
      }

      .cart-item {
        background-color: white;
        border-radius: 10px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
      }

      .cart-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .cart-badge {
        position: absolute;
        top: -3px;
        right: 62px;
        background-color: var(--danger-color);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .nav-link {
        position: relative;
      }

      .invoice-container {
        background-color: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
      }

      .invoice-header {
        border-bottom: 3px solid var(--primary-color);
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
      }

      .invoice-header h2 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .invoice-table {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1.5rem;
      }

      .invoice-table th {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        padding: 1rem;
        border: none;
      }

      .invoice-table td {
        padding: 1rem;
        border: 1px solid #e0e0e0;
      }

      .total-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 1.5rem;
        border: 1px solid #e0e0e0;
      }

      .discount-section {
        background-color: #fff3cd;
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 1.5rem;
        border: 1px solid #ffeaa7;
      }

      .btn-print {
        background-color: var(--secondary-color);
        border: none;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-pdf {
        background-color: var(--warning-color);
        border: none;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-save {
        background-color: var(--success-color);
        border: none;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-history {
        background-color: #6c757d;
        border: none;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
      }

      .history-item {
        background-color: white;
        border-radius: 10px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
      }

      .history-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .quantity-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .quantity-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quantity-btn:hover {
        background-color: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
      }

      .quantity-input {
        width: 50px;
        text-align: center;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.3rem;
      }

      .loading-spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
      }

      .sort-indicator {
        font-size: 0.8em;
        margin-right: 5px;
      }

      .invoice-number {
        font-weight: 700;
        color: var(--primary-color);
      }

      .invoice-date {
        color: #6c757d;
        font-weight: 500;
      }

      .empty-cart-message {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
      }

      .empty-cart-message i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
      }

      .discount-input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .discount-input-group .form-control {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.6rem 1rem;
      }

      .discount-input-group .form-control:focus {
        border-color: var(--warning-color);
        box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
      }

      .discount-label {
        font-weight: 600;
        color: #856404;
        margin-bottom: 0.5rem;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
      }

      .total-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary-color);
      }

      .history-section {
        display: none;
      }

      @media (max-width: 768px) {
        body {
          font-size: 14px;
        }

        .table-container {
          font-size: 13px;
          overflow-x: auto;
        }

        .table th,
        .table td {
          padding: 0.6rem;
        }

        .btn-add-cart {
          padding: 0.4rem 0.8rem;
          font-size: 12px;
        }

        .cart-item {
          padding: 0.8rem;
        }

        .invoice-container {
          padding: 1rem;
        }

        .invoice-table {
          font-size: 13px;
        }

        .invoice-table th,
        .invoice-table td {
          padding: 0.6rem;
        }

        .discount-input-group {
          flex-direction: column;
          gap: 0.5rem;
        }

        .navbar-brand {
          font-size: 1.1rem;
        }

        .navbar-nav {
          font-size: 14px;
        }
      }

      @media print {
        body {
          background-color: white;
        }

        .card {
          box-shadow: none;
          border: 1px solid #ddd;
        }

        .btn {
          display: none !important;
        }

        .navbar {
          display: none;
        }

        .container {
          max-width: 100%;
          padding: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-shop"></i> نظام إدارة المنتجات
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#" onclick="showProducts()">
                <i class="bi bi-box-seam"></i> المنتجات
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showInvoice()">
                <i class="bi bi-receipt"></i> الفاتورة
                <span class="cart-badge" id="cartCount" style="display: none"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showHistory()">
                <i class="bi bi-clock-history"></i> سجل الفواتير
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Loading Spinner -->
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container mt-4">
      <!-- Products Section -->
      <div id="productsSection">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-table"></i> قائمة المنتجات</h5>
              </div>
              <div class="card-body">
                <!-- Search Box -->
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input
                    type="text"
                    class="form-control"
                    id="searchInput"
                    placeholder="ابحث عن منتج..."
                  />
                </div>

                <!-- Products Table -->
                <div class="table-container">
                  <table class="table table-hover" id="productsTable">
                    <thead>
                      <tr>
                        <th onclick="sortTable(0)">
                          اسم الصنف
                          <i class="bi bi-arrow-down-up sort-indicator"></i>
                        </th>
                        <th onclick="sortTable(1)">
                          المقاس
                          <i class="bi bi-arrow-down-up sort-indicator"></i>
                        </th>
                        <th onclick="sortTable(2)">
                          المسلسل
                          <i class="bi bi-arrow-down-up sort-indicator"></i>
                        </th>
                        <th onclick="sortTable(3)">
                          السعر
                          <i class="bi bi-arrow-down-up sort-indicator"></i>
                        </th>
                        <th>الإجراءات</th>
                      </tr>
                    </thead>
                    <tbody id="productsTableBody">
                      <!-- Products will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoice Section -->
      <div id="invoiceSection" style="display: none">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div
                class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap"
              >
                <h5 class="mb-0"><i class="bi bi-receipt"></i> الفاتورة</h5>
                <div class="d-flex gap-2 flex-wrap mt-2 mt-md-0">
                  <button
                    class="btn btn-save text-white"
                    onclick="saveInvoice()"
                  >
                    <i class="bi bi-save"></i> حفظ الفاتورة
                  </button>
                  <button
                    class="btn btn-print text-white"
                    onclick="printInvoice()"
                  >
                    <i class="bi bi-printer"></i> طباعة
                  </button>
                  <button
                    class="btn btn-pdf text-white"
                    onclick="generatePDF()"
                  >
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="invoiceContent" class="invoice-container">
                  <!-- Invoice Header -->
                  <div class="invoice-header">
                    <h2>فاتورة بيع</h2>
                    <p class="invoice-date mb-0">
                      التاريخ: <span id="invoiceDate"></span>
                    </p>
                    <p class="invoice-number mb-0">
                      الرقم: <span id="invoiceNumber"></span>
                    </p>
                  </div>

                  <!-- Customer Info -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <h5>بيانات العميل</h5>
                      <input
                        type="text"
                        class="form-control mb-3"
                        id="customerName"
                        placeholder="اسم العميل"
                      />
                      <input
                        type="text"
                        class="form-control"
                        id="customerPhone"
                        placeholder="رقم الهاتف"
                      />
                    </div>
                    <div class="col-md-6">
                      <h5>ملاحظات</h5>
                      <textarea
                        class="form-control"
                        id="invoiceNotes"
                        rows="3"
                        placeholder="ملاحظات إضافية..."
                      ></textarea>
                    </div>
                  </div>

                  <!-- Cart Items -->
                  <div id="cartItems">
                    <!-- Cart items will be displayed here -->
                  </div>

                  <!-- Discount Section -->
                  <div
                    class="discount-section"
                    id="discountSection"
                    style="display: none"
                  >
                    <h5 class="discount-label">
                      <i class="bi bi-percent"></i> الخصم
                    </h5>
                    <div class="discount-input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="fixedDiscount"
                        placeholder="خصم مبلغ (ج.م)"
                        min="0"
                        step="0.01"
                      />
                      <input
                        type="number"
                        class="form-control"
                        id="percentageDiscount"
                        placeholder="خصم نسبة (%)"
                        min="0"
                        max="100"
                        step="0.1"
                      />
                    </div>
                  </div>

                  <!-- Total Section -->
                  <div
                    class="total-section"
                    id="totalSection"
                    style="display: none"
                  >
                    <div class="row">
                      <div class="col-md-6 offset-md-6">
                        <div class="total-row">
                          <span>المجموع الفرعي:</span>
                          <span id="subtotal">0.00 ج.م</span>
                        </div>
                        <div
                          class="total-row"
                          id="discountRow"
                          style="display: none"
                        >
                          <span>الخصم:</span>
                          <span id="discountAmount">0.00 ج.م</span>
                        </div>
                        <div class="total-row">
                          <span>ضريبة القيمة المضافة (15%):</span>
                          <span id="tax">0.00 ج.م</span>
                        </div>
                        <div class="total-row">
                          <span>الإجمالي:</span>
                          <span id="total">0.00 ج.م</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Empty Cart Message -->
                  <div id="emptyCartMessage" class="empty-cart-message">
                    <i class="bi bi-cart-x"></i>
                    <h4>السلة فارغة</h4>
                    <p>أضف منتجات من قائمة المنتجات لإنشاء فاتورة</p>
                    <button class="btn btn-primary" onclick="showProducts()">
                      <i class="bi bi-arrow-left"></i> العودة للمنتجات
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div id="historySection" class="history-section">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0">
                  <i class="bi bi-clock-history"></i> سجل الفواتير
                </h5>
              </div>
              <div class="card-body">
                <div id="historyList">
                  <!-- History items will be displayed here -->
                </div>
                <div id="emptyHistory" class="empty-cart-message">
                  <i class="bi bi-inbox"></i>
                  <h4>لا توجد فواتير محفوظة</h4>
                  <p>قم بإنشاء وحفظ الفواتير لتظهر هنا</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
      // Sample CSV Data
      const csvData = [
        ["اسم الصنف", "المقاس", "المسلسل", "السعر"],
        ["كوع لحام 87.5 درجة", "20 مم", "351020001", "12.75"],
        ["كوع لحام 87.5 درجة", "25 مم", "351020002", "17.5"],
        ["كوع لحام 87.5 درجة", "32 مم", "351020003", "33.5"],
        ["كوع لحام 87.5 درجة", "40 مم", "351020004", "66.5"],
        ["كوع لحام 87.5 درجة", "50 مم", "351020005", "124"],
        ["كوع لحام 87.5 درجة", "63 مم", "351020006", "171"],
        ["كوع لحام 87.5 درجة", "75 مم", "351020007", "211"],
        ["كوع لحام 87.5 درجة", "90 مم", "351020008", "444.75"],
        ["كوع لحام 87.5 درجة", "110 مم", "351020009", "826"],
        ["كوع لحام 45 درجة", "20 مم", "351010001", "21.5"],
        ["كوع لحام 45 درجة", "25 مم", "351010002", "24.5"],
        ["كوع لحام 45 درجة", "32 مم", "351010003", "36.5"],
        ["كوع لحام 45 درجة", "40 مم", "351010004", "75.75"],
        ["كوع لحام 45 درجة", "50 مم", "351010005", "128.75"],
        ["كوع لحام 45 درجة", "63 مم", "351010006", "180.5"],
        ["كوع لحام 45 درجة", "75 مم", "351010007", "218.5"],
        ["كوع لحام 45 درجة", "90 مم", "351010008", "431.75"],
        ["كوع لحام 45 درجة", "110 مم", "351010009", "871.5"],
        ["كوع لحام ذكر", "20x45 مم", "351010061", "21.5"],
        ["كوع لحام ذكر", "25x45 مم", "351010062", "25.25"],
        ["كوع لحام ذكر", "20x90 مم", "351020061", "13.5"],
        ["كوع لحام ذكر", "25x90 مم", "351020062", "20"],
        ["كرنك لحام", "10 مم", "351030001", "20.75"],
        ["كرنك لحام", "25 مم", "351030002", "35.5"],
        ["كرنك لحام", "32 مم", "351030003", "48.5"],
      ];

      let products = [];
      let cart = [];
      let currentSortColumn = -1;
      let sortDirection = "asc";
      let invoices = JSON.parse(localStorage.getItem("invoices")) || [];

      // Initialize the application
      function init() {
        loadProducts();
        setupEventListeners();
        updateCartCount();
        loadHistory();
      }

      // Load products from CSV data
      function loadProducts() {
        products = [];
        for (let i = 1; i < csvData.length; i++) {
          products.push({
            name: csvData[i][0],
            size: csvData[i][1],
            serial: csvData[i][2],
            price: parseFloat(csvData[i][3]),
          });
        }
        displayProducts(products);
      }

      // Display products in table
      function displayProducts(productsToShow) {
        const tbody = document.getElementById("productsTableBody");
        tbody.innerHTML = "";

        productsToShow.forEach((product) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.size}</td>
                    <td>${product.serial}</td>
                    <td>${product.price.toFixed(2)} ج.م</td>
                    <td>
                        <button class="btn btn-add-cart btn-sm text-white" onclick="addToCart('${
                          product.serial
                        }')">
                            <i class="bi bi-cart-plus"></i> إضافة
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // Setup event listeners
      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProducts = products.filter(
              (product) =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.size.toLowerCase().includes(searchTerm) ||
                product.serial.toLowerCase().includes(searchTerm)
            );
            displayProducts(filteredProducts);
          });

        document
          .getElementById("fixedDiscount")
          .addEventListener("input", calculateTotals);
        document
          .getElementById("percentageDiscount")
          .addEventListener("input", calculateTotals);
      }

      // Sort table
      function sortTable(columnIndex) {
        const columns = ["name", "size", "serial", "price"];
        const column = columns[columnIndex];

        if (currentSortColumn === columnIndex) {
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          sortDirection = "asc";
          currentSortColumn = columnIndex;
        }

        const sortedProducts = [...products].sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];

          if (column === "price") {
            aVal = parseFloat(aVal);
            bVal = parseFloat(bVal);
          }

          if (sortDirection === "asc") {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        displayProducts(sortedProducts);
        updateSortIndicators(columnIndex);
      }

      // Update sort indicators
      function updateSortIndicators(activeColumn) {
        const headers = document.querySelectorAll("th i.sort-indicator");
        headers.forEach((indicator, index) => {
          if (index === activeColumn) {
            indicator.className =
              sortDirection === "asc"
                ? "bi bi-arrow-up sort-indicator"
                : "bi bi-arrow-down sort-indicator";
          } else {
            indicator.className = "bi bi-arrow-down-up sort-indicator";
          }
        });
      }

      // Add product to cart
      function addToCart(serial) {
        const product = products.find((p) => p.serial === serial);
        if (product) {
          const existingItem = cart.find((item) => item.serial === serial);
          if (existingItem) {
            existingItem.quantity += 1;
          } else {
            cart.push({
              ...product,
              quantity: 1,
            });
          }
          updateCartCount();
          showNotification("تمت إضافة المنتج إلى السلة", "success");
        }
      }

      // Update cart count
      function updateCartCount() {
        const cartCount = document.getElementById("cartCount");
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        if (totalItems > 0) {
          cartCount.style.display = "flex";
          cartCount.textContent = totalItems;
        } else {
          cartCount.style.display = "none";
        }
      }

      // Show notification
      function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        notification.style.zIndex = "9999";
        notification.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>${message}
            `;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Show products section
      function showProducts() {
        document.getElementById("productsSection").style.display = "block";
        document.getElementById("invoiceSection").style.display = "none";
        document.getElementById("historySection").style.display = "none";
      }

      // Show invoice section
      function showInvoice() {
        document.getElementById("productsSection").style.display = "none";
        document.getElementById("invoiceSection").style.display = "block";
        document.getElementById("historySection").style.display = "none";
        displayInvoice();
      }

      // Show history section
      function showHistory() {
        document.getElementById("productsSection").style.display = "none";
        document.getElementById("invoiceSection").style.display = "none";
        document.getElementById("historySection").style.display = "block";
        displayHistory();
      }

      // Display invoice
      function displayInvoice() {
        const cartItems = document.getElementById("cartItems");
        const emptyMessage = document.getElementById("emptyCartMessage");
        const totalSection = document.getElementById("totalSection");
        const discountSection = document.getElementById("discountSection");

        if (cart.length === 0) {
          cartItems.innerHTML = "";
          emptyMessage.style.display = "block";
          totalSection.style.display = "none";
          discountSection.style.display = "none";
          return;
        }

        emptyMessage.style.display = "none";
        totalSection.style.display = "block";
        discountSection.style.display = "block";

        cartItems.innerHTML = `
                <div class="table-responsive">
                    <table class="table invoice-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>المقاس</th>
                                <th>السعر</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cart
                              .map(
                                (item) => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.size}</td>
                                    <td>${item.price.toFixed(2)} ج.م</td>
                                    <td>
                                        <div class="quantity-control">
                                            <div class="quantity-btn" onclick="updateQuantity('${
                                              item.serial
                                            }', -1)">
                                                <i class="bi bi-dash"></i>
                                            </div>
                                            <input type="text" class="quantity-input" value="${
                                              item.quantity
                                            }" readonly>
                                            <div class="quantity-btn" onclick="updateQuantity('${
                                              item.serial
                                            }', 1)">
                                                <i class="bi bi-plus"></i>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${(item.price * item.quantity).toFixed(
                                      2
                                    )} ج.م</td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;

        calculateTotals();
      }

      // Update quantity
      function updateQuantity(serial, change) {
        const item = cart.find((item) => item.serial === serial);
        if (item) {
          item.quantity += change;
          if (item.quantity <= 0) {
            removeFromCart(serial);
          } else {
            updateCartCount();
            displayInvoice();
          }
        }
      }

      // Remove from cart
      function removeFromCart(serial) {
        cart = cart.filter((item) => item.serial !== serial);
        updateCartCount();
        displayInvoice();
        showNotification("تم حذف المنتج من السلة", "warning");
      }

      // Calculate totals
      function calculateTotals() {
        const subtotal = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        const fixedDiscount =
          parseFloat(document.getElementById("fixedDiscount").value) || 0;
        const percentageDiscount =
          parseFloat(document.getElementById("percentageDiscount").value) || 0;

        let discountAmount =
          fixedDiscount + (subtotal * percentageDiscount) / 100;
        const afterDiscount = subtotal - discountAmount;
        const tax = afterDiscount * 0.15;
        const total = afterDiscount + tax;

        document.getElementById("subtotal").textContent = `${subtotal.toFixed(
          2
        )} ج.م`;
        document.getElementById(
          "discountAmount"
        ).textContent = `${discountAmount.toFixed(2)} ج.م`;
        document.getElementById("tax").textContent = `${tax.toFixed(2)} ج.م`;
        document.getElementById("total").textContent = `${total.toFixed(
          2
        )} ج.م`;

        // Show/hide discount row
        const discountRow = document.getElementById("discountRow");
        if (discountAmount > 0) {
          discountRow.style.display = "flex";
        } else {
          discountRow.style.display = "none";
        }
      }

      // Save invoice
      function saveInvoice() {
        if (cart.length === 0) {
          showNotification("لا يمكن حفظ فاتورة فارغة", "warning");
          return;
        }

        const invoice = {
          id: generateInvoiceNumber(),
          date: new Date().toISOString(),
          customerName: document.getElementById("customerName").value || "---",
          customerPhone:
            document.getElementById("customerPhone").value || "---",
          notes: document.getElementById("invoiceNotes").value || "",
          items: [...cart],
          subtotal: cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          ),
          fixedDiscount:
            parseFloat(document.getElementById("fixedDiscount").value) || 0,
          percentageDiscount:
            parseFloat(document.getElementById("percentageDiscount").value) ||
            0,
          tax: 0,
          total: 0,
        };

        // Calculate totals
        const discountAmount =
          invoice.fixedDiscount +
          (invoice.subtotal * invoice.percentageDiscount) / 100;
        const afterDiscount = invoice.subtotal - discountAmount;
        invoice.tax = afterDiscount * 0.15;
        invoice.total = afterDiscount + invoice.tax;

        // Save to localStorage
        invoices.unshift(invoice);
        localStorage.setItem("invoices", JSON.stringify(invoices));

        showNotification("تم حفظ الفاتورة بنجاح", "success");

        // Clear cart
        cart = [];
        updateCartCount();
        displayInvoice();
      }

      // Load history
      function loadHistory() {
        // Invoices are already loaded from localStorage
      }

      // Display history
      function displayHistory() {
        const historyList = document.getElementById("historyList");
        const emptyHistory = document.getElementById("emptyHistory");

        if (invoices.length === 0) {
          historyList.innerHTML = "";
          emptyHistory.style.display = "block";
          return;
        }

        emptyHistory.style.display = "none";

        historyList.innerHTML = invoices
          .map(
            (invoice) => `
                <div class="history-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">فاتورة رقم: ${invoice.id}</h6>
                            <p class="mb-1 text-muted">التاريخ: ${formatHijriDate(
                              new Date(invoice.date)
                            )}</p>
                            <p class="mb-0">العميل: ${invoice.customerName}</p>
                        </div>
                        <div class="text-end">
                            <h5 class="text-primary mb-1">${invoice.total.toFixed(
                              2
                            )} ج.م</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${
                              invoice.id
                            }')">
                                <i class="bi bi-eye"></i> عرض
                            </button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // View saved invoice
      function viewInvoice(invoiceId) {
        const invoice = invoices.find((inv) => inv.id === invoiceId);
        if (invoice) {
          // Load invoice data
          cart = [...invoice.items];
          document.getElementById("customerName").value = invoice.customerName;
          document.getElementById("customerPhone").value =
            invoice.customerPhone;
          document.getElementById("invoiceNotes").value = invoice.notes;
          document.getElementById("fixedDiscount").value =
            invoice.fixedDiscount;
          document.getElementById("percentageDiscount").value =
            invoice.percentageDiscount;

          updateCartCount();
          showInvoice();
        }
      }

      // Print invoice
      function printInvoice() {
        window.print();
      }

      // Generate PDF
      function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4",
        });

        // Add Arabic font support
        doc.addFont(
          "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf",
          "Roboto",
          "normal"
        );
        doc.setFont("Roboto");

        // Header
        doc.setFontSize(20);
        doc.text("فاتورة بيع", 105, 20, { align: "center" });

        doc.setFontSize(12);
        doc.text(`التاريخ: ${formatHijriDate(new Date())}`, 20, 35);
        doc.text(`الرقم: ${generateInvoiceNumber()}`, 20, 42);

        // Customer info
        const customerName =
          document.getElementById("customerName").value || "---";
        const customerPhone =
          document.getElementById("customerPhone").value || "---";

        doc.text("بيانات العميل:", 20, 55);
        doc.text(`الاسم: ${customerName}`, 20, 62);
        doc.text(`الهاتف: ${customerPhone}`, 20, 69);

        // Table
        const tableData = cart.map((item) => [
          item.name,
          item.size,
          `${item.price.toFixed(2)}`,
          item.quantity.toString(),
          `${(item.price * item.quantity).toFixed(2)}`,
        ]);

        doc.autoTable({
          head: [["المنتج", "المقاس", "السعر", "الكمية", "الإجمالي"]],
          body: tableData,
          startY: 80,
          styles: {
            font: "Roboto",
            fontSize: 10,
          },
          headStyles: {
            fillColor: [44, 62, 80],
          },
        });

        // Totals
        const subtotal = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        const fixedDiscount =
          parseFloat(document.getElementById("fixedDiscount").value) || 0;
        const percentageDiscount =
          parseFloat(document.getElementById("percentageDiscount").value) || 0;
        const discountAmount =
          fixedDiscount + (subtotal * percentageDiscount) / 100;
        const afterDiscount = subtotal - discountAmount;
        const tax = afterDiscount * 0.15;
        const total = afterDiscount + tax;

        const finalY = doc.lastAutoTable.finalY + 10;

        doc.text(`المجموع الفرعي: ${subtotal.toFixed(2)} ج.م`, 140, finalY);
        if (discountAmount > 0) {
          doc.text(`الخصم: ${discountAmount.toFixed(2)} ج.م`, 140, finalY + 7);
        }
        doc.text(`الضريبة (15%): ${tax.toFixed(2)} ج.م`, 140, finalY + 14);
        doc.setFontSize(14);
        doc.text(`الإجمالي: ${total.toFixed(2)} ج.م`, 140, finalY + 21);

        // Save PDF
        doc.save(`فاتورة_${generateInvoiceNumber()}.pdf`);
        showNotification("تم إنشاء ملف PDF بنجاح", "success");
      }

      // Generate invoice number
      function generateInvoiceNumber() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const random = Math.floor(Math.random() * 1000);
        return `${year}${month}${day}-${random}`;
      }

      // Format Hijri date
      function formatHijriDate(date) {
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          calendar: "islamic",
        };
        return date.toLocaleDateString("ar-SA", options);
      }

      // Set invoice date
      document.getElementById("invoiceDate").textContent = formatHijriDate(
        new Date()
      );
      document.getElementById("invoiceNumber").textContent =
        generateInvoiceNumber();

      // Initialize on load
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
